<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<script src="https://d3js.org/d3.v5.min.js">
</script>
</head>
<body>
<style>
body{max-width:800px;margin:50px auto;padding:0;background-color:#000;color:#fff;font-size:21px}.play-button{margin-top:1.5em;margin-bottom:2em;width:5em;font-size:15px}input[type=range]{-webkit-appearance:none;-moz-apperance:none;width:40%;height:8px;padding:0 0;background:#8b8f92;border-radius:2px;margin-top:25px}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;-moz-apperance:none;width:25px;height:25px;-webkit-border-radius:20px;-moz-border-radius:20px;-ms-border-radius:20px;-o-border-radius:20px;border-radius:20px;background-image:-webkit-gradient(linear,left top,left bottom,color-stop(0,#fefefe),color-stop(.49,#d7d7d7),color-stop(.51,#d1d1d1),color-stop(1,#c8c8c8));border:1px solid #787878}input[type=range]::-moz-range-thumb{box-shadow:1px 1px 1px #000,0 0 1px #0d0d0d;border:1px solid #000;height:20px;width:20px;border-radius:20px;background:#fff;cursor:pointer}input[type=range]::-ms-thumb{box-shadow:1px 1px 1px #000,0 0 1px #0d0d0d;border:1px solid #000;height:20px;width:20px;border-radius:20px;background:#fff;cursor:pointer}
</style>
<div>
<span>
<label>
Train speed (as fraction of ùëê):
<span id="train-speed-text" style="min-width: 3em; display: inline-block;">
0.1
</span>
<input id="input-train-speed" max="0.5" min="0" name="input-train-speed" oninput="updateTrainSpeed(this.value)" step=".005" type="range" value=".1"/>
</label>
</span>
</div>
<div>
<button class="play-button" id="btn-run-animation" onclick="beginAnimation()">
Start
</button>
<button class="play-button" disabled="" id="btn-reset-animation" onclick="stopAnimation()">
Reset
</button>
</div>
<svg id="canvas" style="margin: 0 auto; display: block;" xmlns="http://www.w3.org/2000/svg">
</svg>
<script type="text/javascript">
"use strict";const USER_INFO={trainSpeed:.1},CONFIG=Object.freeze({durationMSOfAnimationReset:300,easingForAnimationReset:d3.easePoly.exponent(2.5),xMarginProptn:0,yMarginProptn:.15,trainWidthProptn:.4,trainHeightProptn:.6,nTiesVisible:9,axDistTraveledAsFracOfTrainWidth:1.2,maxTrainSpeed:.5,trainCar:{class:"train-car",attrs:{fill:"#4ff8",stroke:"#fff8"}},trainLightSource:{class:"train-light-source",attrs:{fill:"white",stroke:"white"}},trainPhoton:{class:"train-photon",attrs:{fill:"#fff8",stroke:"white"}},railroadTie:{class:"railroad-tie",attrs:{stroke:"white","stroke-width":6}},railroadRail:{class:"railroad-rail",attrs:{stroke:"white","stroke-width":5}},canvasText:{attrs:{fill:"white","font-size":"30px","font-family":"sans-serif"}},configure:function(t,a){return Object.keys(a).forEach(n=>{const i=a[n];if("attrs"===n){const a=i;Object.keys(a).forEach(n=>{t.attr(n,a[n])})}else{if("class"!==n)throw new Error(`Unexpected key ${n}`);t.classed(i,!0)}}),t}});function toTitleCase(t){return t.replace(/\b\w+/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})}function updateTrainSpeed(t){const a=void 0!==t?t:document.getElementById("input-train-speed").value;try{const t=parseFloat(a);(t<0||t>1)&&console.log(`Got invalid speed (outside [0,1]): ${t}`);const n=Math.max(0,Math.min(t,1));USER_INFO.trainSpeed=n,document.getElementById("train-speed-text").textContent=a}catch(t){console.log(a)}}function getRailroadTieParams({trackInteriorAxMinX:t,trackInteriorAxMaxX:a,nTiesVisible:n}){const i=(a-t)/(n-1);return{axDistBtwnTies:i,initialTieAxX:(t+a)/2-Math.floor((n-1)/2)*i}}document.getElementById("input-train-speed").max=`${CONFIG.maxTrainSpeed}`;const AX_MIN_X=5,AX_MIN_Y=3,AX_MAX_X=10,AX_MAX_Y=7,AX_WIDTH=AX_MAX_X-AX_MIN_X,AX_HEIGHT=AX_MAX_Y-AX_MIN_Y,AX_MID_X=AX_MIN_X+(AX_MAX_X-AX_MIN_X)/2,AX_MID_Y=AX_MIN_Y+(AX_MAX_Y-AX_MIN_Y)/2,AX_TRAIN_WIDTH=AX_WIDTH*CONFIG.trainWidthProptn,AX_TRAIN_HEIGHT=AX_HEIGHT*CONFIG.trainHeightProptn,TOTAL_DURATION_SEC=3,TOTAL_DURATION_MS=3e3,CANVAS_WIDTH=800,CANVAS_HEIGHT=550,canvas=d3.select("#canvas").attr("width",800).attr("height",550).attr("background-color","black"),subcanvases=canvas.selectAll().data([{originX:0,originY:0,width:800,height:275,observerIsStandingOn:"train"},{originX:0,originY:275,width:800,height:275,observerIsStandingOn:"ground"}]).enter().append("g").attr("transform",t=>`translate(0, ${t.originY})`).each(function(t){CONFIG.configure(d3.select(this).append("text").text(toTitleCase(`Events as seen from ${t.observerIsStandingOn}`)).attr("y",t.height/10),CONFIG.canvasText)}).classed("subcanvas",!0);function axDistTraveled({fracOfC:t}){return t*AX_TRAIN_WIDTH*CONFIG.axDistTraveledAsFracOfTrainWidth}function transAxisToCanvas(t,{x:a,y:n,dx:i,dy:e}){const r=(a-AX_MIN_X)/AX_WIDTH,s=(n-AX_MIN_Y)/AX_HEIGHT;return{x:t.width*CONFIG.xMarginProptn+r*t.width*(1-2*CONFIG.xMarginProptn),y:t.height*CONFIG.yMarginProptn+s*t.height*(1-2*CONFIG.yMarginProptn),dx:t.width/AX_WIDTH*i,dy:t.height/AX_HEIGHT*e}}function _getTrainAndLightSourcesData(t){const a=AX_MID_X-AX_TRAIN_WIDTH/2,n=AX_MID_Y-AX_TRAIN_HEIGHT/2,i=a+AX_TRAIN_WIDTH,e=n+AX_TRAIN_HEIGHT,r=transAxisToCanvas(t,{x:a,y:n}),s=transAxisToCanvas(t,{x:i,y:e}),o=s.x-r.x,c=s.y-r.y,l=AX_MID_X,d=AX_MID_Y,I=.03*AX_WIDTH,A=.03*AX_HEIGHT,{x:_,y:T,dx:x,dy:h}=transAxisToCanvas(t,{x:l,y:d,dx:I,dy:A}),u=Math.min(x,h),X=u/2,g={shape:"circle",x0:_,originXAttr:"cx"},f={cx:_,cy:T},O={...f,r:u,...CONFIG.trainLightSource.attrs},p={...f,r:X,...CONFIG.trainPhoton.attrs};return[{class:CONFIG.trainCar.class,canvas:t,shape:"rect",x0:r.x,originXAttr:"x",attrs:{x:r.x,y:r.y,width:o,height:c,...CONFIG.trainCar.attrs}},{class:CONFIG.trainLightSource.class,canvas:t,...g,attrs:O},{class:CONFIG.trainPhoton.class,canvas:t,...g,attrs:p,direction:"left"},{class:CONFIG.trainPhoton.class,canvas:t,...g,attrs:p,direction:"right"}]}function _getTracksData(t){const a=AX_MIN_X+.05*AX_WIDTH,n=AX_MAX_X-.05*AX_WIDTH,i=AX_MIN_Y+.05*AX_HEIGHT,e=AX_MAX_Y-.05*AX_HEIGHT,{axDistBtwnTies:r,initialTieAxX:s}=getRailroadTieParams({trackInteriorAxMinX:a,trackInteriorAxMaxX:n,nTiesVisible:CONFIG.nTiesVisible}),o="ground"===t.observerIsStandingOn?CONFIG.nTiesVisible:Math.ceil(CONFIG.nTiesVisible+axDistTraveled({fracOfC:CONFIG.maxTrainSpeed})/r),c=[];for(let a=0;a<o;a++){const n=s+a*r,[i,e]=[{x:n,y:AX_MIN_Y},{x:n,y:AX_MAX_Y}].map(a=>transAxisToCanvas(t,a));c.push({class:CONFIG.railroadTie.class,canvas:t,x0:i.x,shape:"line",attrs:{x1:i.x,y1:i.y,x2:e.x,y2:e.y,...CONFIG.railroadTie.attrs}})}return[i,e].forEach(a=>{const[n,i]=[{x:AX_MIN_X,y:a},{x:AX_MAX_X,y:a}].map(a=>transAxisToCanvas(t,a));c.push({class:CONFIG.railroadRail.class,canvas:t,shape:"line",attrs:{x1:n.x,y1:n.y,x2:i.x,y2:i.y,...CONFIG.railroadRail.attrs}})}),c}function _addGraphicalObjs(t,a){return t.selectAll().data(a).enter().append(t=>d3.create(`svg:${t.shape}`).node()).each(function(t){const a=d3.select(this).classed(t.class,!0);return Object.keys(t.attrs).forEach(n=>{a.attr(n,t.attrs[n])}),a})}function addTracks(t){return _addGraphicalObjs(t,_getTracksData)}function addTrainAndLightSources(t){return _addGraphicalObjs(t,_getTrainAndLightSourcesData)}const tracks=addTracks(subcanvases),trainAndLightSources=addTrainAndLightSources(subcanvases),playbackInfo={animationIsPlaying:!1,animationStartDate:null,animationTimer:null,beginButton:document.getElementById("btn-run-animation"),resetButton:document.getElementById("btn-reset-animation")};function stopAnimation(){playbackInfo.animationIsPlaying=!1,clearTimeout(playbackInfo.animationTimer),playbackInfo.beginButton.disabled=!1,playbackInfo.resetButton.disabled=!0;const t=(new Date).getTime()-playbackInfo.animationStartDate.getTime(),a=CONFIG.easingForAnimationReset,n=CONFIG.durationMSOfAnimationReset*Math.min(1,.5*(1+t/TOTAL_DURATION_MS));tracks.filter(t=>t.class===CONFIG.railroadTie.class&&"train"===t.canvas.observerIsStandingOn).transition().duration(n).ease(a).attr("x1",t=>t.x0).attr("x2",t=>t.x0),trainAndLightSources.each(function(t){d3.select(this).transition().duration(n).ease(a).attr(t.originXAttr,t.x0)})}function beginAnimation(){playbackInfo.animationIsPlaying||(playbackInfo.animationIsPlaying=!0,playbackInfo.animationStartDate=new Date,playbackInfo.beginButton.disabled=!0,playbackInfo.resetButton.disabled=!1,playbackInfo.animationTimer=setTimeout(()=>{playbackInfo.animationIsPlaying=!1,playbackInfo.animationEndDate=new Date},TOTAL_DURATION_MS),subcanvases.each(function(t){const a=transAxisToCanvas(t,{dx:axDistTraveled({fracOfC:USER_INFO.trainSpeed})}).dx,n=transAxisToCanvas(t,{dx:axDistTraveled({fracOfC:1})}).dx;"train"===t.observerIsStandingOn?d3.select(this).selectAll(`.${CONFIG.railroadTie.class}`).transition().duration(0).attr("x1",t=>t.x0).attr("x2",t=>t.x0).transition().duration(TOTAL_DURATION_MS).ease(d3.easeLinear).attr("x1",t=>t.x0-a).attr("x2",t=>t.x0-a):"ground"===t.observerIsStandingOn&&d3.select(this).selectAll(`.${CONFIG.trainCar.class}, .${CONFIG.trainLightSource.class}`).each(function(t){d3.select(this).transition().duration(0).attr(t.originXAttr,t.x0).transition().duration(TOTAL_DURATION_MS).ease(d3.easeLinear).attr(t.originXAttr,t.x0+a)}),d3.select(this).selectAll(`.${CONFIG.trainPhoton.class}`).each(function(t){const a="left"===t.direction?t.x0-n:t.x0+n;d3.select(this).transition().duration(0).attr("cx",t.x0).transition().duration(TOTAL_DURATION_MS).ease(d3.easeLinear).attr("cx",a)})}))}updateTrainSpeed();
</script>
</body>
</html>