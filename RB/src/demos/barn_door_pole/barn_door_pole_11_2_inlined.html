<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<script src="https://d3js.org/d3.v5.min.js">
</script>
</head>
<body>
<style>
body{max-width:800px;margin:50px auto;padding:0;background-color:#000;color:#fff;font-size:21px;font-family:sans-serif}.play-button{margin-top:1.5em;margin-bottom:1em;width:5em;font-size:15px}.highlighted-text{color:#5df}.viz-canvas{padding-top:1em}input[type=range]{-webkit-appearance:none;-moz-apperance:none;width:40%;height:8px;padding:0 0;background:#8b8f92;border-radius:2px;margin-top:25px}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;-moz-apperance:none;width:25px;height:25px;-webkit-border-radius:20px;-moz-border-radius:20px;-ms-border-radius:20px;-o-border-radius:20px;border-radius:20px;background-image:-webkit-gradient(linear,left top,left bottom,color-stop(0,#fefefe),color-stop(.49,#d7d7d7),color-stop(.51,#d1d1d1),color-stop(1,#c8c8c8));border:1px solid #787878}input[type=range]::-moz-range-thumb{box-shadow:1px 1px 1px #000,0 0 1px #0d0d0d;border:1px solid #000;height:20px;width:20px;border-radius:20px;background:#fff;cursor:pointer}input[type=range]::-ms-thumb{box-shadow:1px 1px 1px #000,0 0 1px #0d0d0d;border:1px solid #000;height:20px;width:20px;border-radius:20px;background:#fff;cursor:pointer}
</style>
<div>
<span>
<label>
Relative speed (as fraction of ùëê):
<span class="highlighted-text" id="relative-speed-text" style="min-width: 3em; display: inline-block;">
</span>
<input id="input-relative-speed" max="0.95" min="0.0" name="input-relative-speed" oninput="updateRelativeSpeed(this.value)" step=".05" type="range" value="0"/>
</label>
</span>
</div>
<div>
<p id="barn-pole-rest-length">
Rest length of barn: 6.00m
<br/>
Rest length of pole: 9.00m
</p>
</div>
<div>
<span>
<span>
Barn's Perspective
</span>
<button class="play-button" id="btn-run-animation-barn-perspective" onclick="beginAnimation(bothPlaybackInfo.barnStationary)">
Start
</button>
<button class="play-button" disabled="" id="btn-reset-animation-barn-perspective" onclick="stopAnimation(bothPlaybackInfo.barnStationary)">
Reset
</button>
</span>
<br/>
<span>
Contracted length of pole:
<span class="highlighted-text" id="text-contracted-length-pole">
5
</span>
m
</span>
</div>
<svg class="viz-canvas" id="canvas-barn-perspective" style="margin: 0 auto; display: block;" xmlns="http://www.w3.org/2000/svg">
</svg>
<br/>
<div>
<span>
<span>
Pole's Perspective
</span>
<button class="play-button" id="btn-run-animation-pole-perspective" onclick="beginAnimation(bothPlaybackInfo.poleStationary)">
Start
</button>
<button class="play-button" disabled="" id="btn-reset-animation-pole-perspective" onclick="stopAnimation(bothPlaybackInfo.poleStationary)">
Reset
</button>
</span>
<br/>
<span>
Contracted length of barn:
<span class="highlighted-text" id="text-contracted-length-barn">
5
</span>
m
</span>
</div>
<svg class="viz-canvas" id="canvas-pole-perspective" style="margin: 0 auto; display: block;" xmlns="http://www.w3.org/2000/svg">
</svg>
<script type="text/javascript">
"use strict";function isIterable(t){return null!=t&&"function"==typeof t[Symbol.iterator]}function _addGraphicalObjs(t,e){return t.selectAll().data(e).enter().append(t=>d3.create(`svg:${t.shape}`).node()).each(function(t){const e=d3.select(this).classed(t.class,!0);Object.entries(t.attrs).forEach(([t,a])=>{e.attr(t,a)})})}function lorentzFactor({fracOfC:t}){return t||(t=0),1/Math.sqrt(1-t*t)}const AESTHETIC={solidFill:"#4ff8",solidStroke:"#fff8",durationMSOfAnimationReset:300,easingForAnimationReset:d3.easePoly.exponent(2.5),configure:function(t,e){return Object.entries(e).forEach(([e,a])=>{if("attrs"===e){const e=a;Object.entries(e).forEach((e,a)=>{t.attr(e,a)})}else{if("class"!==e)throw new Error(`Unexpected key ${e}`);t.classed(a,!0)}}),t}},AX_MIN_X=5,AX_MIN_Y=3,AX_MAX_X=10,AX_MAX_Y=7,AX_WIDTH=10-AX_MIN_X,AX_HEIGHT=7-AX_MIN_Y,AX_MID_Y=AX_MIN_Y+(7-AX_MIN_Y)/2,POLE_PHYSICAL_SIZE=9,BARN_PHYSICAL_SIZE=6,POLE_BARN_RATIO=1.5,BARN_WIDTH_PROPTN=.16,BARN_HEIGHT_PROPTN=.8,POLE_WIDTH_PROPTN=.24,AX_STARTPOINT_RATIO=.37,ANIMATION_AX_ENDPOINT=.13,AX_BARN_WIDTH=.16*AX_WIDTH,AX_BARN_HEIGHT=.8*AX_HEIGHT,AX_POLE_WIDTH=.24*AX_WIDTH,TIME_FOR_LIGHT_TO_TRAVERSE_SEC=2,TIME_FOR_LIGHT_TO_TRAVERSE_MS=2e3,CANVAS_WIDTH=800,CANVAS_HEIGHT=100,ANIMATION_STATE={hasNotYetStarted:0,isPlaying:1,hasFinishedPlaying:2},BARN_DOOR_HEIGHT_PROPTN=.5,BARN_DOOR_OFFSET=8,USER_INFO={relativeSpeed:.1},canvas=d3.selectAll(".viz-canvas").attr("width",800).attr("height",100).attr("background-color","black"),subcanvases=canvas.data([{originX:0,originY:0,width:800,height:100,observerIsStandingOn:"barn"},{originX:0,originY:0,width:800,height:100,observerIsStandingOn:"pole"}]).each(function(t){d3.select(this).append("g").attr("transform",`translate(0, ${t.originY})`).classed("subcanvas",!0)}).selectAll("g");function apparentWidthsMeters({fracOfC:t}){const e=lorentzFactor({fracOfC:t});return{barn:BARN_PHYSICAL_SIZE/e,pole:POLE_PHYSICAL_SIZE/e}}const speedInputSlider=document.getElementById("input-relative-speed"),speedTextSpan=document.getElementById("relative-speed-text");function getSpeed(t){t=void 0!==t?t:speedInputSlider.value;const e=parseFloat(t);if(e<0||e>1)throw new Error(`Got invalid speed (outside [0,1]): ${e}`);return e}function transAxisToCanvas(t,{x:e,y:a,dx:n,dy:r}){const s=isIterable(e)?e:[e],o=isIterable(a)?a:[a],i=isIterable(n)?n:[n],c=isIterable(r)?r:[r],d=s.map(t=>(t-AX_MIN_X)/AX_WIDTH),_=o.map(t=>(t-AX_MIN_Y)/AX_HEIGHT),l=d.map(e=>e*t.width),A=_.map(e=>e*t.height),I=i.map(e=>t.width/AX_WIDTH*e),T=c.map(e=>t.height/AX_HEIGHT*e);return{x:isIterable(e)?l:l[0],y:isIterable(a)?A:A[0],dx:isIterable(n)?I:I[0],dy:isIterable(r)?T:T[0]}}function _getBarnData(t,{fracOfC:e,progress:a=0}={}){"barn"===t.observerIsStandingOn&&(e=0),"barn"===t.observerIsStandingOn&&(a=0);const n=lorentzFactor({fracOfC:e}),r=(1-a)*(AX_MIN_X+AX_STARTPOINT_RATIO*AX_WIDTH)+a*(AX_MIN_X+(1-ANIMATION_AX_ENDPOINT)*AX_WIDTH),s=r-.5*AX_BARN_WIDTH/n,o=AX_MID_Y-.5*AX_BARN_HEIGHT,i=BARN_DOOR_HEIGHT_PROPTN*AX_BARN_HEIGHT,c=(AX_BARN_HEIGHT-i)/2,{x:[d,_],y:l,dx:A,dy:[I,T,u]}=transAxisToCanvas(t,{x:[r,s],y:o,dx:AX_BARN_WIDTH/n,dy:[AX_BARN_HEIGHT,i,c]}),O=[A+u,T,u+A+u,T,u+100].join(" ");return[{class:"barn",canvas:t,shape:"rect",midX:d,attrs:{x:_,y:l,width:A,height:I,fill:AESTHETIC.solidFill,stroke:"white","stroke-width":5,"stroke-linecap":"square","stroke-dasharray":O}}]}function _getPoleData(t,{fracOfC:e,progress:a=0}={}){"pole"===t.observerIsStandingOn&&(e=0),"pole"===t.observerIsStandingOn&&(a=0);const n=lorentzFactor({fracOfC:e}),r=(1-a)*(AX_MIN_X+(1-AX_STARTPOINT_RATIO)*AX_WIDTH)+a*(AX_MIN_X+ANIMATION_AX_ENDPOINT*AX_WIDTH),s=r-.5*AX_POLE_WIDTH/n,o=r+.5*AX_POLE_WIDTH/n,i=AX_MID_Y,{x:[c,d,_],y:l}=transAxisToCanvas(t,{x:[s,r,o],y:i});return[{class:"pole",canvas:t,shape:"line",midX:d,attrs:{x1:c,y1:l,x2:_,y2:l,stroke:"white","stroke-width":5}}]}function _getBarnDoorsData(t,{fracOfC:e,progress:a=0,barnData:n,poleData:r}={}){const s=n?n[0]:_getBarnData(t,{fracOfC:e,progress:a})[0],o=r?r[0]:_getPoleData(t,{fracOfC:e,progress:a})[0],{x:i,y:c,width:d,height:_}=s.attrs,l=_*BARN_DOOR_HEIGHT_PROPTN,A=c+(_-l)/2,I=A+l,T={class:"barn-door",barn:s,shape:"line",closed:{y1:A,y2:I},open:{y1:I,y2:I+l}},u={stroke:"white","stroke-width":4},O=i-BARN_DOOR_OFFSET,p=i+d+BARN_DOOR_OFFSET,f=o.attrs.x2<O||o.attrs.x1>O,b=o.attrs.x1>p||o.attrs.x2<p,N=({y1:t,y2:e})=>({y1:t,y2:e}),S=N(f?T.closed:T.open),h=N(b?T.closed:T.open);return[{...T,baseX:O,side:"left",isOpen:!f,attrs:{x1:O,x2:O,...S,...u}},{...T,baseX:p,side:"right",isOpen:!b,attrs:{x1:p,x2:p,...h,...u}}]}function _getBarnAndPoleData(t,{progress:e=0}={}){const a=getSpeed(),n=_getBarnData(t,{fracOfC:a,progress:e}),r=_getBarnDoorsData(t,{fracOfC:a,progress:e}),s=_getPoleData(t,{fracOfC:a,progress:e});return{objects:{barnData:n,barnDoorsData:r,poleData:s},data:[...n,...r,...s]}}function addBarnsAndPoles(t){return _addGraphicalObjs(t,t=>_getBarnAndPoleData(t).data)}addBarnsAndPoles(subcanvases);const bothPlaybackInfo={barnStationary:{stationary:"barn",animationState:ANIMATION_STATE.hasNotYetStarted,animationStartDate:null,animationTimer:null,beginButton:document.getElementById("btn-run-animation-barn-perspective"),resetButton:document.getElementById("btn-reset-animation-barn-perspective")},poleStationary:{stationary:"pole",animationState:ANIMATION_STATE.hasNotYetStarted,animationStartDate:null,animationTimer:null,beginButton:document.getElementById("btn-run-animation-pole-perspective"),resetButton:document.getElementById("btn-reset-animation-pole-perspective")}};function updateRelativeSpeed(t){try{const e=getSpeed(t);USER_INFO.trainSpeed=e,(t||0===t)&&(speedTextSpan.textContent=t),[bothPlaybackInfo.barnStationary,bothPlaybackInfo.poleStationary].forEach(t=>{t.animationState===ANIMATION_STATE.hasNotYetStarted&&(t.beginButton.disabled=0===e)});const{barn:a,pole:n}=apparentWidthsMeters({fracOfC:e});subcanvases.each(function(t){let r,s,o,i,c,d,_,l;const A=d3.select(this);switch("barn"===t.observerIsStandingOn?(r=".barn",s=".pole",i=_getBarnData,o=_getPoleData,c=bothPlaybackInfo.barnStationary,d="text-contracted-length-pole",_=n):(r=".pole",s=".barn",i=_getPoleData,o=_getBarnData,c=bothPlaybackInfo.poleStationary,d="text-contracted-length-barn",_=a),c.animationState){case ANIMATION_STATE.hasNotYetStarted:l=0;break;case ANIMATION_STATE.isPlaying:return;case ANIMATION_STATE.hasFinishedPlaying:l=1;break;default:throw new Error(`Unexpect case ${c.animationState}`)}const I={[r]:i(t,{fracOfC:e,progress:l}),[s]:o(t,{fracOfC:e,progress:l})};I[".barn-door"]=_getBarnDoorsData(t,{barnData:I[".barn"],poleData:I[".pole"]}),document.getElementById(d).textContent=_.toFixed(2),Object.entries(I).forEach(([t,e])=>{A.selectAll(t).data(e).each(function(t){const e=d3.select(this).transition().duration(100).ease(d3.easeCubicOut);Object.entries(t.attrs).forEach(([t,a])=>{e.attr(t,a)})})})})}catch(e){throw console.log(t),e}}function getDurationMS(t){return TIME_FOR_LIGHT_TO_TRAVERSE_MS/t}function beginAnimation(t){if(updateRelativeSpeed(),t.animationIsPlaying)return;const e=getSpeed();if(0===e)return;const a=getDurationMS(e);t.animationState=ANIMATION_STATE.isPlaying,t.animationStartDate=new Date,t.beginButton.disabled=!0,t.resetButton.disabled=!1,t.animationTimer=setTimeout(()=>{t.animationEndDate=new Date,t.animationState=ANIMATION_STATE.hasFinishedPlaying,updateRelativeSpeed()},a);const n=t.stationary,r=d3.easeLinear;subcanvases.filter(t=>t.observerIsStandingOn===n).each(function(t){const n=d3.select(this),s="barn"===t.observerIsStandingOn,o=".barn",i=".pole",c=[o,i],d={};c.forEach(t=>d[t]=d3.select(n.selectAll(t).node()));const _={};c.forEach(t=>_[t]=d[t].datum());const l={[o]:_[o].attrs.width,[i]:_[i].attrs.x2-_[i].attrs.x1},A={[o]:1-ANIMATION_AX_ENDPOINT,[i]:ANIMATION_AX_ENDPOINT},I={};c.forEach(e=>I[e]=transAxisToCanvas(t,{x:AX_MIN_X+A[e]*AX_WIDTH}).x);const T={};c.forEach(t=>T[t]=I[t]-l[t]/2);const u={[o]:T[o]-_[o].attrs.x,[i]:_[i].attrs.x1-T[i]},O=s?u[i]:u[o];let p;if(s){const t=T[i],e=T[i]+l[i];d[i].transition().duration(0).attr("x1",_[i].attrs.x1).attr("x2",_[i].attrs.x2).transition().duration(a).ease(r).attr("x1",t).attr("x2",e),p={x1:t,x2:e}}else d[o].transition().duration(0).attr("x",_[o].attrs.x).transition().duration(a).ease(r).attr("x",T[o]),p={x1:_[i].attrs.x1,x2:_[i].attrs.x2};n.selectAll(".barn-door").each(function(t){const n=d3.select(this),r=t.baseX,c=_[i],d=c.attrs.x1-r-3*BARN_DOOR_OFFSET*e,l=c.attrs.x2-r-("left"===t.side?1:2)*BARN_DOOR_OFFSET*e,A=d/O,I=l/O,T=150/a,f=s?r:r+u[o],b=p.x1<=f&&f<=p.x2,N=function(e){const a=t.closed[e],n=t.open[e],r=d3.interpolateNumber(a,n),s=I<1?d3.easeCubicInOut:d3.easeCubicIn;return function(){return t=>{if(t<A)return a;if(t<A+T){const e=(t-A)/T;return r(d3.easeCubicInOut(e))}if(t<I)return n;if(t<I+T){if(b)return n;return r(s(1-(t-I)/T))}return b?n:a}}},S=n.transition().duration(0).attr("x1",r).attr("x2",r).transition().duration(a).ease(d3.easeLinear).attrTween("y1",N("y1")).attrTween("y2",N("y2"));if(!s){const t=function(){return d3.interpolateNumber(r,r+O)};S.attrTween("x1",t).attrTween("x2",t)}S.transition().duration(100).ease(d3.easeCubicOut).attr("y1",b?t.open.y1:t.closed.y1).attr("y2",b?t.open.y2:t.closed.y2)})})}function stopAnimation(t){t.animationState=ANIMATION_STATE.hasNotYetStarted,clearTimeout(t.animationTimer),t.beginButton.disabled=!1,t.resetButton.disabled=!0,updateRelativeSpeed()}updateRelativeSpeed(0);
</script>
</body>
</html>