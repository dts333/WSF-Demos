<!DOCTYPE html>
<html>
<title>Phylogeny</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<head>
    <style>
        .node circle {
            fill: #999;
        }

        .node text {
            font: 10px sans-serif;
        }

        .node--internal circle {
            fill: #555;
        }

        .node--internal text {
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
        }

        .link {
            fill: none;
            stroke: #555;
            stroke-opacity: 0.4;
            stroke-width: 1.5px;
        }
    </style>
</head>

<body>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <svg xmlns="https://www.w3.org/2000/svg" id="phylo" width=960 height=1200></svg>
    <svg xmlns="https://www.w3.org/2000/svg" id="hier" width=720 height=1000></svg>
    <script type="text/javascript">
        var svg = d3.select('svg'),
            chordata,
            arcgen = d3.arc();

        var data = d3.csv("https://worldscienceuniversity2.s3.us-east-2.amazonaws.com/taxonomy.csv").then(function (data) {
            /*data.forEach(function (d) {
                if (!(d.Class in chordata)) {
                    chordata[d.Class] = []
                }
                if (!(chordata[d.Class].includes(d.Order))) {
                    chordata[d.Class].push(d.Order)
                }
            });
            render(); */
            $.getJSON('https://worldscienceuniversity2.s3.us-east-2.amazonaws.com/chordata_order.json', function (d) {
                chordata = d;
            });
            rend2();
        }

        );

        function render() {
            var orders = 146;
            var linelen = 150;
            var theta = -Math.PI / 2;
            var arcgen = d3.arc();
            arcgen.innerRadius(linelen).outerRadius(linelen + 2);
            var o;
            var dtheta;
            var r;
            var sin;
            var cos;
            for (var c in chordata) {
                o = chordata[c].length - 1;
                dtheta = Math.max(2 * Math.PI * o / orders - 0.02, 0);
                theta += 0.02;
                theta += dtheta / 2;
                svg.append("line").attr("x1", 360).attr("y1", 480).attr("x2", 360 + linelen * Math.sin(theta)).attr("y2", 480 - linelen * Math.cos(theta)).attr("stroke-width", 2).attr("stroke", "black");
                theta -= dtheta / 2;
                svg.append("path").attr("d", arcgen({
                    startAngle: theta,
                    endAngle: theta + dtheta,
                })).attr("transform", "translate(360, 480)");
                for (order in chordata[c]) {
                    sin = Math.sin(theta);
                    cos = Math.cos(theta);
                    svg.append("line").attr("x1", 360 + linelen * sin).attr("y1", 480 - linelen * cos).attr("x2", 360 + 2 * linelen * sin).attr("y2", 480 - 2 * linelen * cos).attr("stroke-width", 2).attr("stroke", "black");
                    if (theta > 0) {
                        r = theta * 180 / Math.PI - 90;
                    }
                    else {
                        r = theta * 180 / Math.PI + 90;
                    }
                    if (theta > 0) {
                        svg.append("text").attr("transform", "translate(" + (360 + 2 * linelen * sin) + "," + (480 - 2 * linelen * cos) + ")rotate(" + r + ")").attr("style", "font-size:9px").attr("text-anchor", "start").text(chordata[c][order]);
                    }
                    else {
                        svg.append("text").attr("transform", "translate(" + (360 + 2 * linelen * sin) + "," + (480 - 2 * linelen * cos) + ")rotate(" + r + ")").attr("style", "font-size:9px").attr("text-anchor", "end").text(chordata[c][order]);
                    }
                    if (o > 0) {
                        theta += dtheta / o;
                    }
                }
                theta += 0.02;
            }
        }

        function rend2() {
            var svg = d3.select("svg"),
                width = +svg.attr("width"),
                height = +svg.attr("height"),
                g = svg.append("g").attr("transform", "translate(" + (width / 2 - 15) + "," + (height / 2 + 25) + ")"),

            var stratify = d3.stratify()
                .parentId(function (d) { return d.id.substring(0, d.id.lastIndexOf(".")); });

            var tree = d3.cluster()
                .size([360, 390])
                .separation(function (a, b) { return (a.parentId == b.parentId ? 1 : 2) / a.depth; });

            d3.json("chordata_order.json").then(function (data) {
                var root = tree(d3.hierarchy(data[0]));

                var link = g.selectAll(".link")
                    .data(root.descendants().slice(1))
                    .enter().append("line")
                    .attr("class", "link")
                    .attr("x1", function (d) { return project(d.x, d.y)[0]; })
                    .attr("y1", function (d) { return project(d.x, d.y)[1]; })
                    .attr("x2", function (d) { return project(d.x, d.parent.y)[0]; })
                    .attr("y2", function (d) { return project(d.x, d.parent.y)[1]; });

                var node = g.selectAll(".node")
                    .data(root.descendants())
                    .enter().append("g")
                    .attr("class", function (d) { return "node" + (d.children ? " node--internal" : " node--leaf"); })
                    .attr("transform", function (d) { return "translate(" + project(d.x, d.y) + ")"; })
                    .attr("id", function (d) { return d.data.id; });

                var arcs = g.selectAll(".node--internal").data().forEach(d => g.append("path")
                    .attr("d",
                        arcgen({
                            startAngle: Math.min(...d.children.map(c => (c.x) / 180 * Math.PI)),
                            endAngle: Math.max(...d.children.map(c => (c.x) / 180 * Math.PI)),
                            innerRadius: d.y,
                            outerRadius: d.y + 2,
                        })
                    )
                    .attr("class", "link"));

                g.selectAll(".node--leaf").append("circle")
                    .attr("r", 2.5)

                g.selectAll(".node--leaf")
                    .append("text")
                    .attr("dy", ".31em")
                    .attr("x", function (d) { return d.x < 180 === !d.children ? 6 : -6; })
                    .style("text-anchor", function (d) { return d.x < 180 === !d.children ? "start" : "end"; })
                    .attr("transform", function (d) { return "rotate(" + (d.x < 180 ? d.x - 90 : d.x + 90) + ")"; })
                    .text(function (d) { return d.data.id; });
            });

            function project(x, y) {
                var angle = (x - 90) / 180 * Math.PI, radius = y;
                return [radius * Math.cos(angle), radius * Math.sin(angle)];
            }
        }

        function connect(a, b) {
            var g = d3.select("g"),
                c,
                links = [],
                nodes = a.path(b);

            nodes.forEach(d => d.append("circle")
                .attr("r", 2.5)
                .attr("class", "highlight")
                .style("fill", d3.color("green"))
                .append("line")
                .attr("class", "highlight")
                .attr("x1", function (d) { return project(d.data.x, d.data.y)[0]; })
                .attr("y1", function (d) { return project(d.data.x, d.data.y)[1]; })
                .attr("x2", function (d) { return project(d.data.x, d.data.parent.y)[0]; })
                .attr("y2", function (d) { return project(d.data.x, d.data.parent.y)[1]; }))
                .style("fill", d3.color("green"))
                .append("path")
                .attr("class", "highlight")
                .attr("d", arcgen({
                    startAngle: d.data.x / 180 * Math.PI,
                    endAngle: d.parent.data.x / 180 * Math.PI,
                    innerRadius: d.parent.data.y,
                    outerRadius: d.parent.data.y + 2,
                }))
                .style("fill", d3.color("green"));
        }
    </script>
</body>